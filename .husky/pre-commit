#!/bin/sh

# remove any previously generated server coverage so lint doesn't pick it up
rm -rf server/coverage || true

# lint only staged files
npx lint-staged

# Run full test suite to ensure everything works together
echo "Running full test suite..."
npm run coverage:run
if [ $? -ne 0 ]; then
  echo "Frontend tests failed. Aborting commit."
  exit 1
fi

echo "Running server test suite..."
npm run coverage:run:server
if [ $? -ne 0 ]; then
  echo "Server tests failed. Aborting commit."
  exit 1
fi

# merge coverage reports
npm run coverage:merge
if [ $? -ne 0 ]; then
  echo "Failed to merge coverage reports. Aborting commit."
  exit 1
fi

# Check overall coverage meets threshold
echo "Checking overall test coverage..."
npm run coverage:check-overall
if [ $? -ne 0 ]; then
  echo "Overall coverage check failed. Aborting commit."
  exit 1
fi

exit 0
